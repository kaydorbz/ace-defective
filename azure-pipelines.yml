trigger:
  - main

pool:
  vmImage: ubuntu-latest

# Connects to the Variable Group we will create in Phase 1
variables:
  - group: AceDefective-Secrets

steps:
  - checkout: self
    submodules: true

  # 1. FIX: Pin Python Version to ensure stability (prevents random breakages)
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.11'
      addToPath: true
    displayName: 'Set Python Version to 3.11'

  # 2. FIX: Manual Build Script
  # We install dependencies and run Pelican ourselves so we know it works.
  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
      pelican content -o output -s publishconf.py
    displayName: 'Install Dependencies & Build Site'

# 3. FIX: Deploy the Pre-Built Folder
  - task: AzureStaticWebApp@0
    inputs:
      # Since we built it manually, the "App" is now just the output folder.
      app_location: 'output' 
      api_location: ''
      output_location: '' # Leave empty because app_location is already the build result
      skip_app_build: true
      azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN)